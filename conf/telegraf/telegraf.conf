# Telegraf configuration — TRITIUM-SC central server
# Subscribes to MQTT topics, parses JSON telemetry, writes to InfluxDB v2.

[agent]
  interval = "10s"
  flush_interval = "10s"

# ---------------------------------------------------------------------------
# MQTT Consumers — one per measurement for clean topic parsing
# ---------------------------------------------------------------------------

# Robot telemetry: tritium/{site}/robots/{robot_id}/telemetry
[[inputs.mqtt_consumer]]
  servers = ["mqtt://mosquitto:1883"]
  topics = ["tritium/+/robots/+/telemetry"]
  qos = 0
  data_format = "json"
  name_override = "robot_telemetry"
  [[inputs.mqtt_consumer.topic_parsing]]
    topic = "tritium/+/robots/+/telemetry"
    tags = "_/site/_/robot_id/_"

# Camera detections: tritium/{site}/cameras/{camera_id}/detections
[[inputs.mqtt_consumer]]
  servers = ["mqtt://mosquitto:1883"]
  topics = ["tritium/+/cameras/+/detections"]
  qos = 0
  data_format = "json"
  name_override = "camera_detections"
  [[inputs.mqtt_consumer.topic_parsing]]
    topic = "tritium/+/cameras/+/detections"
    tags = "_/site/_/camera_id/_"

# Sensor events: tritium/{site}/sensors/{sensor_id}/events
[[inputs.mqtt_consumer]]
  servers = ["mqtt://mosquitto:1883"]
  topics = ["tritium/+/sensors/+/events"]
  qos = 0
  data_format = "json"
  name_override = "sensor_events"
  [[inputs.mqtt_consumer.topic_parsing]]
    topic = "tritium/+/sensors/+/events"
    tags = "_/site/_/sensor_id/_"

# Device status (retained): tritium/{site}/{category}/{device_id}/status
[[inputs.mqtt_consumer]]
  servers = ["mqtt://mosquitto:1883"]
  topics = ["tritium/+/+/+/status"]
  qos = 1
  data_format = "json"
  name_override = "device_status"

# ---------------------------------------------------------------------------
# Local system metrics — CPU, memory, disk, network on the central server
# ---------------------------------------------------------------------------

[[inputs.cpu]]
  percpu = false
  totalcpu = true

[[inputs.mem]]

[[inputs.disk]]
  mount_points = ["/"]

[[inputs.net]]
  interfaces = ["eth*", "wlan*"]

# ---------------------------------------------------------------------------
# Output — InfluxDB v2
# ---------------------------------------------------------------------------

[[outputs.influxdb_v2]]
  urls = ["http://influxdb:8086"]
  token = "$INFLUX_TOKEN"
  organization = "tritium"
  bucket = "telemetry"
